---
title : "R Exercises - TGA data"
date  : "`r Sys.Date()`"
output: 
    html_document:
        toc_depth      : 4
        highlight      : tango
        number_sections: true
        code_download  : FALSE
---

- Load the `tidyverse` package
- Download the TGA data file <a href="Data/ATG.txt" download target="_blank">ATG.txt</a>
- Load it into a `tibble`.

```{r message=FALSE, warning=FALSE, cache=FALSE, include=TRUE}
library(tidyverse)
d <- tibble(read.table("ATG.txt", 
                skip=12,
                header=FALSE, 
                nrows=4088))
names(d) <- c("Index", "t", "Ts", "Tr", "Value")
```

- Plot the mass (column `Value`) as a function of the temperature `Tr` (Temperature Read) with lines, using `ggplot2`
    + Remove data from the temperature decrease
    + Define nice axis labels with the units
    + Convert degrees Celsius to Kelvins

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
# Defining what is the row number of max Tr value
treshold <- which(d$Tr==max(d$Tr))
# Filtering data until max Tr value
d1 <- subset(head(d,treshold))

# Filtering data from >25 Tr value
d2 <- filter(d1, Tr>25)
# Plotting the top graph
p1 <- d2 %>% 
    ggplot(aes(x=Tr+ 273,y=Value)) + 
    geom_point(alpha=0.5, size=0.05) +
    labs(x="", y="Mass [mg]") +
    theme_bw() ; p1
```


- Write a function returning the derivative $\partial y/\partial x$ given two vectors x and y

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
# Derivative function
drv_3 <- function(x,y){
    diff(y)/diff(x)
}

```


- Add the temperature derivative of the mass reading in a red dashed line in a panel below the previous graph
    + Zoom on the data to see the variations
    + Remove the x label of the top panel and have the same x axis for both panels
    + Try to reproduce the following graph:

```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
# Defining new data with the derivative function
mass_drv <- drv_3(d2$Tr,d2$Value)

# Defining Zoomed and Combined data
d3 <- filter(d1, Tr>25.3) %>%
    cbind(data.frame(Derivative=mass_drv))

# Defining lowest derivative value /for following vertical dashed line
drv_low <- d3$Tr[[which(d3$Derivative==min(d3$Derivative))]]+273

# Redefining adjusted Top Graph (removing x_label, adding vert. line, break range)
p1 <- p1 +  theme(
    axis.title.x = element_blank(),
    axis.text.x=element_blank()) +
    geom_vline(xintercept=drv_low, lty=2, size=0.6, alpha=0.5) +
    scale_x_continuous(breaks=c(300, 400, 500, 600, 700 ,800 ,900 ,1000 ,1100))

# Defining Bottom Graph
p2 <- d3 %>%
    ggplot(aes(x=Tr + 273,y=Derivative)) +
    geom_line(linetype=2, size=.4,col="red") +
    labs(x="T [K]", y="Derivative") +
    geom_vline(xintercept=drv_low, lty=2, size=0.6, alpha=0.5) +
    ylim(-0.15, 0.05) +
    scale_x_continuous(breaks=c(300, 400, 500, 600, 700 ,800 ,900 ,1000 ,1100)) +
    theme_bw()

# Engaging both graphs referring the template one
library(patchwork)
(p1/p2) + plot_layout(height = c(4, 1))
```
