---
title : "R Exercises - Treatment of Molecular Dynamics data"
date  : "`r Sys.Date()`"
output: 
    html_document:
        toc            : yes
        toc_float      : yes
        toc_depth      : 4
        highlight      : tango
        number_sections: false
        code_download  : FALSE
---



```{r include=TRUE, warning = FALSE, message=FALSE, cache=FALSE}
library(tidyverse)
library(units)
library(ggforce)
derivative <- function(x, y, n=1) {
    # returns d^ny/dx^n
    d <- tibble(x=x, y=y)
    for (i in 1:n) {
        x  <- d$x
        y  <- d$y
        dy <- diff(y)/diff(x)# the actual derivative
        dx <- x[-length(x)]+diff(x)/2# centers the X values
        d  <- tibble(x=dx,y=dy)
    }
    d
}
Diffusion_Coeff <- function(x,y,min=0.5, max=.9) {
    d <- derivative(x,y)
    d <- d[d$x > min*max(d$x) & d$x < max*max(d$x), ]
    tibble(D     = mean(d$y)/6, 
           D_err = sd(d$y)/6) %>% 
    mutate(D_err=set_units(D_err,"Å^2/ns")) %>% 
    mutate(D = set_units(D,"m^2/s"),
           D_err=set_units(D_err,"m^2/s"))
}
files <- list.files(path="Data", pattern = "MSD")

d <- tibble(file=files) %>% 
    mutate(data=map(file,
            ~ read_table2(file.path("Data",.), 
                        skip=1, col_names=c("t","MSD")))) %>% 
    unnest(data) %>% 
    mutate(t = set_units(t,"ns"),
           MSD=set_units(MSD,"Å^2")) %>% 
    nest(data=-file) %>% 
    mutate(epskt=as.numeric(gsub("MSD_bulk","",gsub(".txt","",gsub("MSD_CS0.5_","",file))))) %>% 
    mutate(D=map_dbl(data, ~ Diffusion_Coeff(.$t,.$MSD)$D)) %>% 
    mutate(D_err=map_dbl(data, ~ Diffusion_Coeff(.$t,.$MSD)$D_err)) %>% 
    mutate(Deriv=map(data, ~ derivative(.$t,.$MSD))) %>%
    mutate(tau=D/D[file=="MSD_bulk.txt"],
           tau_err=tau*(D_err/D+D_err[file=="MSD_bulk.txt"]/D[file=="MSD_bulk.txt"])
           ) %>% 
    unnest(Deriv)

d %>% filter(y>set_units(0,Å^2/ns)) %>% 
    ggplot(aes(x=x, y=y, group=file, color=file))+
        geom_point(alpha=0.5)+
        scale_x_unit(unit = 's') +
        scale_y_unit(unit = 'm^2/s') +
        geom_hline(aes(yintercept=D*6))+
        theme_bw()


```