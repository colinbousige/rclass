---
title : "R Exercises - Load and plot multiple files"
date  : "`r Sys.Date()`"
output: 
    html_document:
        toc            : no
        toc_float      : no
        toc_depth      : 4
        highlight      : tango
        number_sections: false
        code_download  : FALSE
params: 
    solution:
        value: FALSE
---

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align="center"}
library(downloadthis)
download_link(
  link = "./Archive.zip",
  output_name = "Data Files",
  button_label = "Download Data Files",
  button_type = "default",
  has_icon = TRUE,
  icon = "fa fa-save",
  self_contained = FALSE
)
```
<br>

----

In this typical exercise, we will learn how to read multiple files and plot them all together. This is the basic step of data analysis.


- Load the `tidyverse` and `readxl` libraries

```{r echo=params$solution, warning = FALSE, message=FALSE, cache=FALSE}
library(tidyverse)
library(readxl)
```

- Store into `flist` the list of all `.xls` files in the `Data/` folder. Take a look at the `list.files()`{.R} function for this.

```{r echo=params$solution, warning = FALSE, message=FALSE, cache=FALSE}
flist <- list.files(path="Data", pattern = ".xls", full.names = TRUE)
```

- Open one of the .xls files and study the structure of the file. The first group of 2-column data is the blank measurement, while the second group under the blank is the actual raw measurement. Working on the first file in the list, successively:
    + Read and store the blank data
    + Read and store the raw data
    + Combine them into a data.frame (or a tibble) containing the columns `w`, `blank`, `raw`, and `transmittance`, the later being the transmittance (in percent) with respect to the blank measurement.

The final table should look like this:

```{r echo=params$solution, warning = FALSE, message=FALSE, cache=FALSE}
blank.df <- read_excel(flist[1], 
            skip=7, 
            n_max = 3401, 
            col_names = c("w","blank"))
raw.df   <- read_excel(flist[1], 
            skip=3412, 
            n_max = 3401, 
            col_names = c("w","raw"))
# Base R version
alldata <- tibble(blank.df, raw=raw.df$raw)
alldata$transmittance <- alldata$raw/alldata$blank*100
alldata
# Tidyverse version:
# alldata <- inner_join(blank.df, raw.df, by = "w") %>% 
#     mutate(transmittance=raw/blank*100)
```

- Wrap this into a function `readFTIR()`{.R} that, given a file name, returns a data.frame (or a tibble) with the columns `w`, `blank`, `raw`, and `transmittance`. Test it on the first file in the list.

```{r echo=params$solution, warning = FALSE, message=FALSE, cache=FALSE}
readFTIR <- function(filename) {
    blank.df <- read_excel(filename, 
                skip=7, 
                n_max = 3401, 
                col_names = c("w","blank"))
    raw.df   <- read_excel(filename, 
                skip=3412, 
                n_max = 3401, 
                col_names = c("w","raw"))
    # Base R version
    alldata <- tibble(blank.df, raw=raw.df$raw)
    alldata$transmittance <- alldata$raw/alldata$blank*100
    alldata
    # Tidyverse version:
    # inner_join(blank.df, raw.df, by = "w") %>% 
    #     mutate(transmittance=raw/blank*100)
}
```

- Plot the first file in `flist`, and try to make your plot look like this:

```{r echo=params$solution, warning = FALSE, message=FALSE, cache=FALSE}
readFTIR(flist[1]) %>% 
    ggplot(aes(x=w, y=raw))+
        geom_line(size=1)+
        geom_line(aes(y=blank), lty=2, col="gray")+
        labs(x=expression(paste("Wavenumber [", cm^{-1},"]")),
             y="Transmittance [%]")+
        scale_x_continuous(breaks=seq(0,5000,500))+
        theme_bw()+
        theme(panel.grid=element_blank(),
              text=element_text(size=16))
```

- Now we want to read all files in the list and store them in a tidy data.frame. For this we will start easy and use a `for` loop.
    + Define an empty data.frame called `df`
    + Define a `for` loop on all elements of `flist`
    + Then successively:
        + Read the current file with the above-defined function and store it in `tempdf`
        + Add the column `name` to `tempdf` containing the current file name. If needed, trim the path from the name string using `basename()`{.R}.
        + Stack `tempdf` below `df` by binding them row-wise.

The final table should look like this:

```{r echo=params$solution, warning = FALSE, message=FALSE, cache=FALSE}
df <- tibble()
for(file in flist){
    tempdf <- readFTIR(file)
    tempdf$name <- basename(file)
    df <- bind_rows(df, tempdf)
}
df
```

- More advanced: you can do this without using a `for` loop using the `tidyverse`

```{r echo=params$solution, warning = FALSE, message=FALSE, cache=FALSE}
df  <- tibble(name = flist) %>% 
    mutate(data=map(name, ~readFTIR(.)),
           name=basename(name)) %>% 
    unnest(data)
```

- Plot all these files together using `ggplot2`. You can try several things, like:
    + Plot them all together in one frame with a color depending on the file name.
    + Plot them all on a different frame (facet_wrap) for each file.

The final plots should look like this:

```{r echo=params$solution, warning = FALSE, message=FALSE, cache=FALSE}
theme_set(theme_bw()+
          theme(strip.background = element_blank(),
                strip.text = element_text(face="bold")))
ggplot(data=df, aes(x=w, y=transmittance, color=name))+
    geom_line()+
    labs(x=expression(paste("Wavenumber [", cm^{-1},"]")),
         y="Transmittance [%]")
ggplot(data=df, aes(x=w, y=transmittance))+
    geom_line()+
    labs(x=expression(paste("Wavenumber [", cm^{-1},"]")),
         y="Transmittance [%]")+
    facet_wrap(~name)
```

- You see in the file names that there are actually 5 samples with 2 temperatures for each. Based on the column `name` of the `df` data.frame, create the columns `sample` and `temperature` that contain *numerical values*. Think about using the function `gsub()`{.R} to replace (delete) text in a string, the `substr(string, start, end)`{.R} function to get a portion of a string.

```{r echo=params$solution, warning = FALSE, message=FALSE, cache=FALSE}
# Base version
df$sample      <- as.numeric(substr(df$name,8,8))
df$temperature <- substr(df$name,10,20)
df$temperature <- as.numeric(gsub("C.xls","",df$temperature))
# tidyverse version
df  <- tibble(name = flist) %>% 
    mutate(data=map(name, ~readFTIR(.)),
           name=basename(name)) %>% 
    mutate(name=gsub("sample_","",name)) %>% 
    mutate(name=gsub("C.xls","",name)) %>% 
    separate(name, c("sample","temperature"), convert = TRUE) %>% 
    unnest(data)
```

- Now it is time to make nicer plots:
    - Make a grid plot showing the data evolution for each sample as a function of temperature
    - Make a grid plot with one frame per sample, and the two temperatures in different colors.

The final plots should look like this:

```{r echo=params$solution, warning = FALSE, message=FALSE, cache=FALSE}
ggplot(data=df, aes(x=w, y=transmittance))+
    geom_line()+
    labs(x=expression(paste("Wavenumber [", cm^{-1},"]")),
         y="Transmittance [%]")+
    facet_grid(paste("Sample", sample) ~ paste(temperature,"ºC"))
ggplot(data=df, aes(x=w, y=transmittance, color=factor(temperature)))+
    geom_line()+
    labs(x=expression(paste("Wavenumber [", cm^{-1},"]")),
         y="Transmittance [%]",
         color="Temperature [ºC]")+
    facet_wrap(~paste("Sample",sample))
```
